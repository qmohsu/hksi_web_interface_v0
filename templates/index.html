<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定位与门线指标监控系统</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #2196F3;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 10px;
        }
        
        .device-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .device-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .device-item:last-child {
            border-bottom: none;
        }
        
        .device-info {
            font-weight: bold;
            color: #333;
        }
        
        .device-type-tag {
            background-color: #2196F3;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        
        .device-type-anchor {
            background-color: #4CAF50;
            color: white;
        }
        
        .position-data {
            color: #666;
            font-size: 0.9em;
        }
        
        .gate-metrics-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .gate-metrics-table th,
        .gate-metrics-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .gate-metrics-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .crossing-event {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .crossing-no {
            background-color: #e0e0e0;
            color: #666;
        }
        
        .crossing-left {
            background-color: #FF9800;
            color: white;
        }
        
        .crossing-right {
            background-color: #4CAF50;
            color: white;
        }
        
        .map-container {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .update-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4CAF50;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .no-data {
            text-align: center;
            color: #999;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>定位与门线指标监控系统</h1>
            <p>实时监控标签和锚点位置，以及门线穿越指标</p>
        </div>
        
        <div class="status-bar">
            <div class="status-item">
                <div>标签数量</div>
                <div id="tag-count" class="status-value">0</div>
            </div>
            <div class="status-item">
                <div>锚点数量</div>
                <div id="anchor-count" class="status-value">0</div>
            </div>
            <div class="status-item">
                <div>门线指标</div>
                <div id="gate-metrics-count" class="status-value">0</div>
            </div>
            <div class="status-item">
                <div>最后更新</div>
                <div id="last-update" class="status-value">--:--:--</div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <h2>设备位置</h2>
                <div class="device-list" id="devices-container">
                    <div class="no-data">暂无设备数据</div>
                </div>
            </div>
            
            <div class="card">
                <h2>门线指标</h2>
                <div id="gate-metrics-container">
                    <table class="gate-metrics-table" id="gate-metrics-table">
                        <thead>
                            <tr>
                                <th>标签</th>
                                <th>门线</th>
                                <th>距离(m)</th>
                                <th>位置</th>
                                <th>时间(s)</th>
                                <th>穿越事件</th>
                            </tr>
                        </thead>
                        <tbody id="gate-metrics-body">
                            <tr>
                                <td colspan="6" class="no-data">暂无门线指标数据</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>地图视图</h2>
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
        // 连接WebSocket
        const socket = io();
        let lastUpdate = 0;
        
        // 更新状态栏
        function updateStatusBar(data) {
            const now = new Date();
            document.getElementById('tag-count').textContent = data.tags.length;
            document.getElementById('anchor-count').textContent = data.anchors.length;
            document.getElementById('gate-metrics-count').textContent = data.gate_metrics.length;
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
        }
        
        // 渲染设备列表
        function renderDevices(data) {
            const container = document.getElementById('devices-container');
            
            if (data.tags.length === 0 && data.anchors.length === 0) {
                container.innerHTML = '<div class="no-data">暂无设备数据</div>';
                return;
            }
            
            let html = '';
            
            // 渲染标签
            data.tags.forEach(tag => {
                const pos = tag.position;
                html += `
                    <div class="device-item">
                        <div>
                            <span class="device-info">${tag.info.name}</span>
                            <span class="device-type-tag">标签</span>
                        </div>
                        <div class="position-data">
                            ${pos.lat.toFixed(6)}, ${pos.lon.toFixed(6)}<br>
                            高度: ${pos.alt_m}m | 源: ${getSourceMaskText(pos.source_mask)}
                        </div>
                    </div>
                `;
            });
            
            // 渲染锚点
            data.anchors.forEach(anchor => {
                const pos = anchor.position;
                html += `
                    <div class="device-item">
                        <div>
                            <span class="device-info">${anchor.info.name}</span>
                            <span class="device-type-tag device-type-anchor">锚点</span>
                        </div>
                        <div class="position-data">
                            ${pos.lat.toFixed(6)}, ${pos.lon.toFixed(6)}<br>
                            高度: ${pos.alt_m}m | 源: ${getSourceMaskText(pos.source_mask)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 渲染门线指标
        function renderGateMetrics(data) {
            const tbody = document.getElementById('gate-metrics-body');
            
            if (data.gate_metrics.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">暂无门线指标数据</td></tr>';
                return;
            }
            
            let html = '';
            data.gate_metrics.forEach(metric => {
                const crossingClass = getCrossingEventClass(metric.crossing_event);
                const crossingText = getCrossingEventText(metric.crossing_event);
                
                html += `
                    <tr>
                        <td>${metric.tag_id}</td>
                        <td>${metric.gate_id}</td>
                        <td>${metric.d_perp_m !== undefined ? metric.d_perp_m.toFixed(2) : '--'}</td>
                        <td>${metric.s_along !== undefined ? metric.s_along.toFixed(2) : '--'}</td>
                        <td>${metric.time_to_line_s !== undefined ? metric.time_to_line_s.toFixed(2) : '--'}</td>
                        <td><span class="crossing-event ${crossingClass}">${crossingText}</span></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // 辅助函数：获取源掩码文本
        function getSourceMaskText(mask) {
            const sources = [];
            if (mask & 1) sources.push('UWB');
            if (mask & 4) sources.push('GNSS');
            return sources.join('+') || '未知';
        }
        
        // 辅助函数：获取穿越事件CSS类
        function getCrossingEventClass(event) {
            switch(event) {
                case 'CROSSING_LEFT':
                    return 'crossing-left';
                case 'CROSSING_RIGHT':
                    return 'crossing-right';
                default:
                    return 'crossing-no';
            }
        }
        
        // 辅助函数：获取穿越事件文本
        function getCrossingEventText(event) {
            switch(event) {
                case 'CROSSING_LEFT':
                    return '向左穿越';
                case 'CROSSING_RIGHT':
                    return '向右穿越';
                default:
                    return '无穿越';
            }
        }
        
        // 初始化地图
        let map = null;
        let markers = {};
        let tagIcons = {};
        let anchorIcons = {};
        
        function initMap() {
            // 创建地图，中心点设为香港（示例坐标）
            map = L.map('map').setView([22.3193, 114.1694], 15);
            
            // 添加OpenStreetMap瓦片图层
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // 创建自定义图标
            createCustomIcons();
        }
        
        function createCustomIcons() {
            // 标签图标（蓝色）
            tagIcons.default = L.divIcon({
                className: 'tag-marker',
                html: '<div style="background-color: #2196F3; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">T</div>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            
            // 锚点图标（绿色）
            anchorIcons.default = L.divIcon({
                className: 'anchor-marker',
                html: '<div style="background-color: #4CAF50; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">A</div>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }
        
        function updateMapMarkers(data) {
            if (!map) return;
            
            // 清除过期的标记（不在当前数据中的）
            const currentDeviceIds = new Set();
            
            // 更新标签标记
            data.tags.forEach(tag => {
                const deviceId = tag.info.device_id;
                currentDeviceIds.add(deviceId);
                const pos = tag.position;
                
                if (markers[deviceId]) {
                    // 更新现有标记位置
                    markers[deviceId].setLatLng([pos.lat, pos.lon]);
                    // 更新弹出窗口内容
                    markers[deviceId].setPopupContent(createPopupContent(tag));
                } else {
                    // 创建新标记
                    const marker = L.marker([pos.lat, pos.lon], {
                        icon: tagIcons.default
                    }).addTo(map);
                    marker.bindPopup(createPopupContent(tag));
                    markers[deviceId] = marker;
                }
            });
            
            // 更新锚点标记
            data.anchors.forEach(anchor => {
                const deviceId = anchor.info.device_id;
                currentDeviceIds.add(deviceId);
                const pos = anchor.position;
                
                if (markers[deviceId]) {
                    markers[deviceId].setLatLng([pos.lat, pos.lon]);
                    markers[deviceId].setPopupContent(createPopupContent(anchor));
                } else {
                    const marker = L.marker([pos.lat, pos.lon], {
                        icon: anchorIcons.default
                    }).addTo(map);
                    marker.bindPopup(createPopupContent(anchor));
                    markers[deviceId] = marker;
                }
            });
            
            // 移除不再存在的设备标记
            for (const deviceId in markers) {
                if (!currentDeviceIds.has(parseInt(deviceId))) {
                    map.removeLayer(markers[deviceId]);
                    delete markers[deviceId];
                }
            }
        }
        
        function createPopupContent(device) {
            const pos = device.position;
            const sourceText = getSourceMaskText(pos.source_mask);
            return `
                <strong>${device.info.name}</strong><br>
                类型: ${device.info.type === 'tag' ? '标签' : '锚点'}<br>
                位置: ${pos.lat.toFixed(6)}, ${pos.lon.toFixed(6)}<br>
                高度: ${pos.alt_m}m<br>
                数据源: ${sourceText}
            `;
        }
        
        // 初始加载数据
        async function loadInitialData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                updateStatusBar(data);
                renderDevices(data);
                renderGateMetrics(data);
                updateMapMarkers(data);
            } catch (error) {
                console.error('加载初始数据失败:', error);
            }
        }
        
        // WebSocket事件处理
        socket.on('connect', () => {
            console.log('WebSocket连接已建立');
            loadInitialData();
        });
        
        socket.on('position_update', (data) => {
            console.log('接收到位置更新:', data);
            // 重新加载完整数据以保持一致性
            loadInitialData();
        });
        
        socket.on('gate_metrics_update', (data) => {
            console.log('接收到门线指标更新:', data);
            // 重新加载完整数据以保持一致性
            loadInitialData();
        });
        
        socket.on('disconnect', () => {
            console.log('WebSocket连接已断开');
        });
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadInitialData();
            
            // 每30秒轮询一次以防WebSocket失效
            setInterval(loadInitialData, 30000);
        });
    </script>
</body>
</html>